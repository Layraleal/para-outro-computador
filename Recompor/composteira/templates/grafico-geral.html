{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Recompor</title>
  <link rel="stylesheet" href="{% static 'css/estilo.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>
  <link rel="stylesheet" href="{% static 'css/grafico-geral.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header>
    {% include 'navbar.html' %}
  </header>

  <h1 id="bem-vindo">Olá, {{ user.get_username }}!</h1>
  <h3 id="area">Todas Composteiras</h3>

  <div id="container">
    <div id="lado1">
      <div class="swiper mySwiper">
        <div id="todas-comp" class="swiper-wrapper">
          {% for composteira in composteiras %}
          <div class="swiper-slide">
            <section class='img-name'>
              {% if composteira.imagem %}
              <img class = 'foto-comp' src="{{ composteira.imagem.url }}" alt="Foto da composteira">
              {% else %}
              <img class = 'foto-comp' src="{% static 'img/composteiraSemFoto.png' %}" alt="Sem imagem">
              {% endif %}                  
              <p class="nome-comp"><a href="{% url 'composteira:graficoIndividual' %}">{{ composteira.nome }}</a></p>  
            </section>
            <section class="dados">
              <p>Construída: {{ composteira.data_construcao }}</p>
              <p>Tipo: {{ composteira.tipo }}</p>
              <a href="{% url 'composteira:editarComposteira' id_composteira=composteira.id_composteira %}" id='graf-ED'>Editar</a>
              <a href="{% url 'composteira:excluirComposteira' composteira.id_composteira %}" id ='graf-EX' >Excluir</a>
            </section>
          </div>
          {% endfor %}
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div> 

    <div class="nova-comp">
			<a  class = aaa href = "{% url 'composteira:addComposteira' %}"><button id = "adicionar-comp">Adicionar nova composteira<img id = seta-tutorial src="{% static 'img/seta-tutorial.png' %}"></button></a>
		</div>

    <div id="lado2">
      <div id="grafico">
        <h2 style="color: #00383b">Minha Redução de Gases do Efeito Estufa</h2>
        <br>
        

        
        <div id="dados-graficos">
          <p id="texto-reducao">Você deixou de emitir: kg de CO₂ no ambiente</p>
        </div>
        

        <div id="selects">
          <select id="periodo">
            <option value="mes-atual">Este mês</option>
            <option value="mes-passado">Mês passado</option>
            <option value="ano">Esse ano</option>
            <option value="personalizado">Escolher outro mês</option>
          </select>
          <input type="month" id="mes-personalizado" style="display:none;">
        </div>


        <canvas id="graficoGeral"></canvas>
      </div>
    </div>
  </div>

  <script>
    const compostagens = {{ dados|safe }};
    const ctx = document.getElementById("graficoGeral").getContext("2d");

    function calcularSeries(pesos) {
      const seria = pesos.map(p => p * 1000 * 0.85);
      const foi = pesos.map(p => p * 1000 * 0.084);
      return { seria, foi };
    }

    function filtrarPorPeriodo(periodo, mesCustomizado = null) {
    const hoje = new Date();
    let inicio, fim;

    if (periodo === "mes-atual") {
      inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
    } 
    else if (periodo === "mes-passado") {
      inicio = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
      fim = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
    } 
    else if (periodo === "ano") {
      inicio = new Date(hoje.getFullYear(), 0, 1);
      fim = new Date(hoje.getFullYear(), 11, 31);
    } 
    else if (periodo === "personalizado" && mesCustomizado) {
      const [ano, mes] = mesCustomizado.split("-");
      inicio = new Date(ano, mes - 1, 1);
      fim = new Date(ano, mes, 0);
    }

    const filtradas = compostagens.datas.map((d, i) => {
      const data = new Date(d);
      return data >= inicio && data <= fim ? i : null;
    }).filter(i => i !== null);

    const labels = filtradas.map(i => compostagens.labels[i]);
    const pesos = filtradas.map(i => compostagens.pesos[i]);

    return { labels, pesos };
  }

    function atualizarGrafico(periodo, mesCustomizado = null) {
      const { labels, pesos } = filtrarPorPeriodo(periodo, mesCustomizado);
      const { seria, foi } = calcularSeries(pesos);

      const totalReducao = ((seria.reduce((a,b)=>a+b,0) - foi.reduce((a,b)=>a+b,0)) / 1000).toFixed(2);
      document.getElementById("texto-reducao").textContent = `Você deixou de emitir: ${totalReducao} kg de CO₂ no ambiente`;

      grafico.data.labels = labels;
      grafico.data.datasets[0].data = seria;
      grafico.data.datasets[1].data = foi;
      grafico.update();
    }

    const { seria, foi } = calcularSeries(compostagens.pesos);

    const grafico = new Chart(ctx, {
      type: "line",
      data: {
        labels: compostagens.labels,
        datasets: [
          { label: "O que seria emitido", data: seria, borderColor: "#DD0802", backgroundColor: "#DD0802", borderWidth: 3, fill: false },
          { label: "O que foi emitido", data: foi, borderColor: "#CDF3E5", backgroundColor: "#CDF3E5", borderWidth: 3, fill: false }
        ]
      },
      options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'g CO₂' } 
                        } 
                    },
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.formattedValue} g`;
                                }
                            }
                        }
                    }
                }
    });

    // Evento do seletor de período
    document.getElementById("periodo").addEventListener("change", e => {
      const periodo = e.target.value;
      const inputMes = document.getElementById("mes-personalizado");

      if (periodo === "personalizado") {
        inputMes.style.display = "inline-block";
      } else {
        inputMes.style.display = "none";
        atualizarGrafico(periodo);
      }
    });

    // Evento do input de mês personalizado
    document.getElementById("mes-personalizado").addEventListener("change", e => {
      atualizarGrafico("personalizado", e.target.value);
    });
  </script>

  <script src="{% static 'js/navegacao.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
  <script src="{% static 'js/tamanho.js' %}"></script>
</body>
</html>
